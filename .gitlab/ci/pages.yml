# GitLab Pages deployment for documentation and downloads

# Validate documentation early in pipeline
validate:docs:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip install --no-cache-dir mkdocs mkdocs-material mkdocs-mermaid2-plugin pyyaml
  script:
    # Build documentation with strict mode (archive/ excluded via exclude_docs in mkdocs.yml)
    - mkdocs build --strict --site-dir _site_test 2>&1 | tee docs_build.log
    # Count warnings and fail if critical errors
    - |
      warnings=$(grep -c "^WARNING" docs_build.log || echo 0)
      errors=$(grep -c "^ERROR" docs_build.log || echo 0)
      echo "Documentation build: $warnings warnings, $errors errors"
      if [ "$errors" -gt 0 ]; then
        echo "FAILED: Documentation has $errors errors"
        exit 1
      fi
      if [ "$warnings" -gt 50 ]; then
        echo "WARNING: Documentation has $warnings warnings (threshold: 50)"
      fi
    # Check for orphaned files (docs not in nav)
    - |
      echo "Checking for orphaned documentation files..."
      orphaned=0
      for file in $(find docs -name "*.md" -type f); do
        basename=$(basename "$file" .md)
        dirname=$(dirname "$file" | sed 's|docs/||')
        if [ "$dirname" = "docs" ]; then dirname=""; fi

        # Skip index.md files - they are directory indices
        if [ "$basename" = "index" ]; then continue; fi

        # Check if file is referenced in mkdocs.yml
        if ! grep -q "$basename" mkdocs.yml; then
          echo "WARNING: Orphaned file - $file (not in mkdocs.yml nav)"
          orphaned=$((orphaned + 1))
        fi
      done
      if [ $orphaned -gt 0 ]; then
        echo "Found $orphaned orphaned documentation files"
        # Don't fail the job, just warn
      fi
    # Verify LLM docs generator exists
    - test -f scripts/generate-llms-docs.py || echo "WARNING - generate-llms-docs.py not found"
  artifacts:
    when: on_failure
    paths:
      - _site_test
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - docs/**/*
        - mkdocs.yml
    - if: $CI_COMMIT_TAG

pages:
  stage: deploy
  image: python:3.11-slim
  needs:
    - job: build:binary:linux-amd64
      artifacts: true
      optional: true
    - job: build:binary:darwin-arm64
      artifacts: true
      optional: true
    - job: checksums:generate
      artifacts: true
      optional: true
    - job: package:rpm:x86_64
      artifacts: true
      optional: true
    - job: package:deb:amd64
      artifacts: true
      optional: true
    - job: package:macos-pkg
      artifacts: true
      optional: true
  before_script:
    # Install mkdocs and dependencies
    - pip install --no-cache-dir mkdocs mkdocs-material mkdocs-mermaid2-plugin pyyaml
  script:
    # Build documentation with strict mode to catch errors
    - mkdocs build --strict --site-dir public

    # Generate LLM-friendly documentation formats into public/
    - echo "Generating LLM-friendly documentation formats..."
    - python scripts/generate-llms-docs.py public

    # Create downloads directory
    - mkdir -p public/downloads

    # Copy binary artifacts from build jobs
    - |
      echo "Copying binary artifacts to downloads..."
      for binary in dist/bin/huskycat-*; do
        if [ -f "$binary" ]; then
          cp "$binary" public/downloads/
          echo "  Copied $(basename "$binary")"
        fi
      done

    # Copy checksums
    - |
      if [ -f "dist/bin/SHA256SUMS.txt" ]; then
        cp dist/bin/SHA256SUMS.txt public/downloads/
        echo "  Copied SHA256SUMS.txt"
      fi

    # Copy RPM/DEB packages if available
    - |
      for pkg in dist/rpm/*.rpm dist/deb/*.deb; do
        if [ -f "$pkg" ]; then
          cp "$pkg" public/downloads/
          echo "  Copied $(basename "$pkg")"
        fi
      done

    # Copy macOS PKG if available
    - |
      for pkg in dist/macos/*.pkg; do
        if [ -f "$pkg" ]; then
          cp "$pkg" public/downloads/
          echo "  Copied $(basename "$pkg")"
        fi
      done

    # Generate downloads index
    - |
      cat > public/downloads/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
        <title>HuskyCat Downloads</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
          h1 { color: #333; }
          .downloads { list-style: none; padding: 0; }
          .downloads li { margin: 10px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
          .downloads a { color: #0066cc; text-decoration: none; font-weight: 500; }
          .downloads a:hover { text-decoration: underline; }
          .meta { color: #666; font-size: 0.9em; margin-top: 5px; }
          .install-cmd { background: #2d2d2d; color: #fff; padding: 15px; border-radius: 5px; margin: 20px 0; font-family: monospace; }
        </style>
      </head>
      <body>
        <h1>HuskyCat Downloads</h1>
        <p>Binary releases and installation scripts for HuskyCat.</p>

        <h2>Quick Install</h2>
        <div class="install-cmd">curl -fsSL https://huskycat-570fbd.gitlab.io/install.sh | bash</div>

        <h2>Binary Releases</h2>
        <ul class="downloads">
      EOF

      # List all downloads
      for file in public/downloads/*; do
        if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
          filename=$(basename "$file")
          size=$(du -h "$file" | cut -f1)
          echo "<li><a href=\"$filename\">$filename</a><div class=\"meta\">Size: $size</div></li>" >> public/downloads/index.html
        fi
      done

      echo "</ul></body></html>" >> public/downloads/index.html

    # Copy verified install script from scripts/
    - cp scripts/install.sh public/install.sh
    - chmod +x public/install.sh

  artifacts:
    paths:
      - public

  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

  environment:
    name: production
    url: https://huskycat-570fbd.gitlab.io
