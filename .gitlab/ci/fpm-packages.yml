# SPDX-License-Identifier: Apache-2.0
# FPM-based Linux Package Generation
#
# Creates RPM and DEB packages from the fat binary using FPM (Effing Package Management)
# Packages include:
# - Binary at /usr/local/bin/huskycat
# - Desktop entry for application menu
# - Configuration example at /etc/huskycat/
# - Icons for desktop integration
#
# RPM Matrix: Rocky Linux 8, 9, 10 (separate builds per version)
# DEB: Debian/Ubuntu amd64
#
# Usage:
#   include:
#     - local: '/.gitlab/ci/fpm-packages.yml'

variables:
  FPM_VERSION: "1.15.1"
  PACKAGE_RELEASE: "1"
  PACKAGE_MAINTAINER: "HuskyCat Project <huskycat@tinyland.ai>"
  PACKAGE_URL: "https://huskycat-570fbd.gitlab.io"
  PACKAGE_LICENSE: "Apache-2.0"
  PACKAGE_VENDOR: "Tinyland AI"
  PACKAGE_DESCRIPTION: "Universal Code Validation Platform - AI-powered linting and formatting"

# Base template for FPM jobs
.fpm_base:
  image: ruby:3.2-slim
  stage: package
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends rpm binutils
    - gem install fpm -v $FPM_VERSION --no-document
    - fpm --version
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# Shared script for creating package root directory
.fpm_prepare_root: &fpm_prepare_root
  - |
    if [ -n "$CI_COMMIT_TAG" ]; then
      PACKAGE_VERSION="$CI_COMMIT_TAG"
    else
      PACKAGE_VERSION="2.0.0"
    fi
    echo "Package version: $PACKAGE_VERSION"
  # Create package directory structure
  - mkdir -p pkg-root/usr/local/bin
  - mkdir -p pkg-root/usr/share/huskycat
  - mkdir -p pkg-root/etc/huskycat
  - mkdir -p pkg-root/usr/share/applications
  - mkdir -p pkg-root/usr/share/icons/hicolor/256x256/apps
  - mkdir -p pkg-root/usr/share/doc/huskycat
  # Copy binary
  - cp dist/bin/huskycat-linux-amd64 pkg-root/usr/local/bin/huskycat
  - chmod +x pkg-root/usr/local/bin/huskycat
  # Copy assets
  - if [ -f assets/linux/huskycat.desktop ]; then cp assets/linux/huskycat.desktop pkg-root/usr/share/applications/; elif [ -f assets/huskycat.desktop ]; then cp assets/huskycat.desktop pkg-root/usr/share/applications/; else printf '[Desktop Entry]\nVersion=1.0\nType=Application\nName=HuskyCat\nGenericName=Code Validator\nComment=Universal Code Validation Platform\nExec=huskycat-tray\nIcon=huskycat\nCategories=Development;IDE;\nTerminal=false\nStartupNotify=true\nKeywords=validation;linting;git;hooks;\n' > pkg-root/usr/share/applications/huskycat.desktop; fi
  - |
    if [ -f assets/icons/huskycat-256.png ]; then
      cp assets/icons/huskycat-256.png pkg-root/usr/share/icons/hicolor/256x256/apps/huskycat.png
    fi
  # Copy documentation
  - cp README.md pkg-root/usr/share/doc/huskycat/
  - cp LICENSE pkg-root/usr/share/doc/huskycat/
  # Copy example configuration
  - |
    if [ -f docs/examples/.huskycat.yaml ]; then
      cp docs/examples/.huskycat.yaml pkg-root/etc/huskycat/huskycat.yaml.example
    fi

# RPM Package - Generic (works on Rocky 8/9/10, RHEL, Fedora)
package:rpm:x86_64:
  extends: .fpm_base
  needs:
    - job: build:binary:linux-amd64
      artifacts: true
  variables:
    ARCH: x86_64
  script:
    - *fpm_prepare_root
    - echo "Building RPM package for ${ARCH}..."
    - |
      fpm -s dir -t rpm \
        --name huskycat \
        --version "${PACKAGE_VERSION#v}" \
        --iteration "${PACKAGE_RELEASE}" \
        --architecture "${ARCH}" \
        --description "${PACKAGE_DESCRIPTION}" \
        --url "${PACKAGE_URL}" \
        --maintainer "${PACKAGE_MAINTAINER}" \
        --license "${PACKAGE_LICENSE}" \
        --vendor "${PACKAGE_VENDOR}" \
        --category "Development/Tools" \
        --depends "git >= 2.0" \
        --config-files /etc/huskycat \
        --rpm-summary "Universal Code Validation Platform" \
        --rpm-auto-add-directories \
        --after-install scripts/fpm-postinstall.sh \
        --before-remove scripts/fpm-preremove.sh \
        -C pkg-root \
        .
    - mkdir -p dist/rpm
    - mv *.rpm dist/rpm/
    - ls -la dist/rpm/
    - echo "RPM package created successfully"
  artifacts:
    paths:
      - dist/rpm/*.rpm
    expire_in: 1 month

# DEB Package (Debian/Ubuntu)
package:deb:amd64:
  extends: .fpm_base
  needs:
    - job: build:binary:linux-amd64
      artifacts: true
  variables:
    ARCH: amd64
  script:
    - *fpm_prepare_root
    - echo "Building DEB package for ${ARCH}..."
    - |
      fpm -s dir -t deb \
        --name huskycat \
        --version "${PACKAGE_VERSION#v}" \
        --iteration "${PACKAGE_RELEASE}" \
        --architecture "${ARCH}" \
        --description "${PACKAGE_DESCRIPTION}" \
        --url "${PACKAGE_URL}" \
        --maintainer "${PACKAGE_MAINTAINER}" \
        --license "${PACKAGE_LICENSE}" \
        --vendor "${PACKAGE_VENDOR}" \
        --category "devel" \
        --depends "git" \
        --config-files /etc/huskycat \
        --deb-priority optional \
        --deb-compression xz \
        --after-install scripts/fpm-postinstall.sh \
        --before-remove scripts/fpm-preremove.sh \
        -C pkg-root \
        .
    - mkdir -p dist/deb
    - mv *.deb dist/deb/
    - ls -la dist/deb/
    - echo "DEB package created successfully"
  artifacts:
    paths:
      - dist/deb/*.deb
    expire_in: 1 month

# Publish packages to GitLab Package Registry
publish:rpm:
  stage: deploy
  image: curlimages/curl:latest
  needs:
    - job: package:rpm:x86_64
      artifacts: true
  script:
    - |
      PACKAGE_VERSION="${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
      echo "Publishing RPM packages to GitLab Package Registry..."
      for rpm_file in dist/rpm/*.rpm; do
        if [ -f "$rpm_file" ]; then
          filename=$(basename "$rpm_file")
          echo "Uploading $filename..."
          curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
            --upload-file "$rpm_file" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/huskycat/${PACKAGE_VERSION}/${filename}"
        fi
      done
      echo "RPM upload complete"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

publish:deb:
  stage: deploy
  image: curlimages/curl:latest
  needs:
    - job: package:deb:amd64
      artifacts: true
  script:
    - |
      PACKAGE_VERSION="${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"
      echo "Publishing DEB packages to GitLab Package Registry..."
      for deb_file in dist/deb/*.deb; do
        if [ -f "$deb_file" ]; then
          filename=$(basename "$deb_file")
          echo "Uploading $filename..."
          curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
            --upload-file "$deb_file" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/huskycat/${PACKAGE_VERSION}/${filename}"
        fi
      done
      echo "DEB upload complete"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

# Package verification job
verify:packages:
  stage: deploy
  image: ubuntu:22.04
  needs:
    - job: package:deb:amd64
      artifacts: true
    - job: package:rpm:x86_64
      artifacts: true
      optional: true
  script:
    - echo "Verifying packages..."
    - apt-get update && apt-get install -y file rpm
    # Verify DEB
    - |
      for deb in dist/deb/*.deb; do
        if [ -f "$deb" ]; then
          echo "--- DEB: $(basename $deb) ---"
          file "$deb"
          dpkg-deb --info "$deb"
          dpkg-deb --contents "$deb" | head -20
        fi
      done
    # Verify RPM
    - |
      for rpm_file in dist/rpm/*.rpm; do
        if [ -f "$rpm_file" ]; then
          echo "--- RPM: $(basename $rpm_file) ---"
          file "$rpm_file"
          rpm -qip "$rpm_file"
          rpm -qlp "$rpm_file" | head -20
        fi
      done
    - echo "Package verification complete"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
