#!/usr/bin/env bash
# .githooks/commit-msg - Validate conventional commit format
#
# Format: <type>(<scope>): <description>
#
# Types:
#   feat     - New feature
#   fix      - Bug fix
#   docs     - Documentation changes
#   style    - Code style changes (formatting, semicolons, etc.)
#   refactor - Code refactoring (no feature change, no bug fix)
#   test     - Adding or updating tests
#   chore    - Maintenance tasks
#   perf     - Performance improvements
#   ci       - CI/CD changes
#   build    - Build system changes
#   revert   - Reverting a previous commit
#
# Examples:
#   feat: add user authentication
#   fix(api): resolve login endpoint error
#   docs: update installation guide
#   refactor(core): simplify validation logic

set -euo pipefail

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source shared utilities
source "${SCRIPT_DIR}/_/common.sh"

# ============================================================================
# MAIN
# ============================================================================

main() {
    local commit_msg_file="$1"
    local commit_msg
    commit_msg=$(cat "$commit_msg_file")
    local first_line
    first_line=$(echo "$commit_msg" | head -n1)

    # Skip validation for merge commits
    if [[ "$first_line" =~ ^Merge ]]; then
        exit 0
    fi

    # Skip validation for revert commits (git generates these)
    if [[ "$first_line" =~ ^Revert ]]; then
        exit 0
    fi

    # Skip validation for fixup/squash commits (used during interactive rebase)
    if [[ "$first_line" =~ ^(fixup|squash)! ]]; then
        exit 0
    fi

    # Conventional commit regex
    # Format: type(scope)!: description
    # - type: required, one of the allowed types
    # - scope: optional, in parentheses
    # - !: optional, indicates breaking change
    # - description: required, after colon and space
    local commit_regex='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?!?: .+'

    if [[ ! "$first_line" =~ $commit_regex ]]; then
        log_error "Commit message does not follow conventional commit format!"
        echo ""
        echo "  Format: <type>(<scope>): <description>"
        echo ""
        echo "  Types:"
        echo "    feat      New feature"
        echo "    fix       Bug fix"
        echo "    docs      Documentation changes"
        echo "    style     Code style changes"
        echo "    refactor  Code refactoring"
        echo "    test      Adding or updating tests"
        echo "    chore     Maintenance tasks"
        echo "    perf      Performance improvements"
        echo "    ci        CI/CD changes"
        echo "    build     Build system changes"
        echo "    revert    Reverting a previous commit"
        echo ""
        echo "  Examples:"
        echo "    feat: add user authentication"
        echo "    fix(api): resolve login endpoint error"
        echo "    docs: update installation guide"
        echo ""
        echo "  Your message: ${first_line}"
        echo ""
        echo "  To bypass: git commit --no-verify -m \"message\""
        echo ""
        exit 1
    fi

    # Optional: Check message length
    local max_length=72
    if [[ ${#first_line} -gt $max_length ]]; then
        log_warn "Commit message first line exceeds $max_length characters (${#first_line})"
        echo "  Consider shortening for better readability in git log"
    fi

    exit 0
}

# Run main with the commit message file as argument
main "$@"
