#!/usr/bin/env bash
# .githooks/pre-push - Full validation before push using HuskyCat
#
# PARADIGM: Eat your own dogfood - uses HuskyCat's own validation engine
#
# REQUIREMENT: UV venv must be active for development in this repository.
#
# This hook runs more comprehensive checks than pre-commit since pushing
# affects the remote repository and CI pipeline.
#
# Features:
#   - Uses HuskyCat validate command for full codebase validation
#   - Uses HuskyCat ci-validate for GitLab CI configuration
#   - Interactive auto-fix prompts
#   - Auto-approve mode: HUSKYCAT_AUTO_APPROVE=1 or AUTO_FIX=1
#   - Skip hooks: SKIP_HOOKS=1 git push (or git push --no-verify)

set -euo pipefail

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source shared utilities
source "${SCRIPT_DIR}/_/common.sh"

# ============================================================================
# MAIN
# ============================================================================

main() {
    log_header "HuskyCat Pre-Push Hook"

    # Check if hooks should be skipped
    if should_skip_hooks; then
        log_warn "Hooks skipped (SKIP_HOOKS=1)"
        exit 0
    fi

    # Verify UV environment is set up
    if ! verify_uv_environment; then
        log_error "UV environment not ready. Run: uv sync --dev"
        exit 1
    fi

    local exit_code=0

    # ------------------------------------------------------------------------
    # 1. HUSKYCAT VALIDATE --ALL (Full codebase validation)
    # ------------------------------------------------------------------------
    log_step "Running HuskyCat full codebase validation..."

    local huskycat_args="--all"

    if is_auto_approve; then
        huskycat_args="$huskycat_args --fix"
        log_info "Auto-fix mode enabled (HUSKYCAT_AUTO_APPROVE=1)"
    elif is_interactive; then
        huskycat_args="$huskycat_args --interactive"
    fi

    log_step "Running: uv run python -m src.huskycat validate $huskycat_args"

    # Run validation and capture exit code properly
    set +e
    uv run python -m src.huskycat validate $huskycat_args
    local validation_exit=$?
    set -e

    if [[ $validation_exit -ne 0 ]]; then
        log_error "HuskyCat validation failed (exit code: $validation_exit)"

        # Check if files were modified
        if [[ -n "$(git status --porcelain 2>/dev/null)" ]]; then
            log_warn "Files modified - please commit changes before pushing"
            echo ""
            echo "  Run: git add -u && git commit --amend --no-edit && git push"
            echo ""
        fi

        exit_code=$validation_exit
    else
        log_info "HuskyCat: All validations passed"
    fi

    [[ $exit_code -ne 0 ]] && exit $exit_code

    # ------------------------------------------------------------------------
    # 2. HUSKYCAT CI-VALIDATE (GitLab CI configuration)
    # ------------------------------------------------------------------------
    if [[ -f ".gitlab-ci.yml" ]]; then
        log_step "Validating GitLab CI configuration with HuskyCat..."

        set +e
        uv run python -m src.huskycat ci-validate .gitlab-ci.yml
        local ci_exit=$?
        set -e

        if [[ $ci_exit -ne 0 ]]; then
            log_error "GitLab CI configuration validation failed"
            exit_code=$ci_exit
        else
            log_info "HuskyCat CI: Configuration valid"
        fi
    fi

    # ------------------------------------------------------------------------
    # SUMMARY
    # ------------------------------------------------------------------------
    if [[ $exit_code -eq 0 ]]; then
        log_header "Pre-Push Passed"
        log_info "All validations passed! Proceeding with push..."
    else
        log_header "Pre-Push Failed"
        log_error "Fix issues above or use: SKIP_HOOKS=1 git push"
    fi

    exit $exit_code
}

# Run main
main "$@"
